<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JT â€” Social Betting</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Bebas+Neue&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

<style>
  :root {
    --bg:#0a0a0f; --surface:#12121a; --surface2:#1a1a26;
    --border:#2a2a3d; --accent:#00ff88; --accent2:#ff3366;
    --accent3:#7b61ff; --text:#e8e8f0; --muted:#6b6b8a;
    --yes:#00ff88; --no:#ff3366;
    --glow:0 0 20px rgba(0,255,136,0.15);
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;min-height:100vh;overflow-x:hidden;}
  body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;
    background:radial-gradient(ellipse 60% 40% at 10% 10%,rgba(123,97,255,.06) 0%,transparent 60%),
               radial-gradient(ellipse 50% 30% at 90% 80%,rgba(0,255,136,.04) 0%,transparent 60%);
    pointer-events:none;z-index:0;}
  #loading-screen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:2000;background:var(--bg);gap:24px;}
  .loading-logo{font-family:'Bebas Neue',cursive;font-size:80px;letter-spacing:10px;background:linear-gradient(135deg,var(--accent),var(--accent3));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  .loading-bar-wrap{width:200px;height:2px;background:var(--border);border-radius:2px;overflow:hidden;}
  .loading-bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent3),var(--accent));animation:loadBar 1.5s ease-in-out infinite;}
  @keyframes loadBar{0%{width:0;margin-left:0}50%{width:100%;margin-left:0}100%{width:0;margin-left:100%}}
  .loading-status{font-family:'Space Mono',monospace;font-size:11px;color:var(--muted);letter-spacing:1px;}
  #auth-screen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1000;background:var(--bg);}
  .auth-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:48px;width:420px;position:relative;overflow:hidden;}
  .auth-box::before{content:'';position:absolute;top:-1px;left:10%;right:10%;height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent);}
  .auth-logo{font-family:'Bebas Neue',cursive;font-size:72px;letter-spacing:12px;background:linear-gradient(135deg,var(--accent),var(--accent3));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-align:center;margin-bottom:4px;}
  .auth-tagline{text-align:center;color:var(--muted);font-size:12px;font-family:'Space Mono',monospace;letter-spacing:2px;margin-bottom:36px;text-transform:uppercase;}
  .auth-tabs{display:flex;background:var(--bg);border-radius:8px;padding:4px;margin-bottom:28px;}
  .auth-tab{flex:1;padding:10px;text-align:center;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;color:var(--muted);transition:all .2s;border:none;background:transparent;font-family:'Inter',sans-serif;}
  .auth-tab.active{background:var(--surface2);color:var(--text);}
  .input-group{margin-bottom:16px;}
  .input-group label{display:block;font-size:11px;font-weight:500;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;font-family:'Space Mono',monospace;}
  .input-group input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px 16px;color:var(--text);font-size:14px;font-family:'Inter',sans-serif;transition:border-color .2s,box-shadow .2s;outline:none;color-scheme:dark;}
  .input-group input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,255,136,.08);}
  .btn-primary{width:100%;padding:14px;background:linear-gradient(135deg,var(--accent),#00cc6a);color:#0a0a0f;font-weight:700;font-size:14px;letter-spacing:1px;text-transform:uppercase;border:none;border-radius:8px;cursor:pointer;transition:all .2s;font-family:'Space Mono',monospace;margin-top:8px;}
  .btn-primary:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(0,255,136,.25);}
  .auth-error{color:var(--accent2);font-size:12px;text-align:center;margin-top:12px;font-family:'Space Mono',monospace;min-height:18px;}
  #app{display:none;position:relative;z-index:1;min-height:100vh;}
  header{position:sticky;top:0;z-index:100;background:rgba(10,10,15,.85);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:0 32px;height:64px;display:flex;align-items:center;justify-content:space-between;}
  .header-logo{font-family:'Bebas Neue',cursive;font-size:36px;letter-spacing:8px;background:linear-gradient(135deg,var(--accent),var(--accent3));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  .header-right{display:flex;align-items:center;gap:16px;}
  .balance-chip{background:var(--surface);border:1px solid var(--border);border-radius:100px;padding:8px 18px;display:flex;align-items:center;gap:8px;font-family:'Space Mono',monospace;font-size:13px;}
  .balance-dot{width:8px;height:8px;background:var(--accent);border-radius:50%;box-shadow:0 0 8px var(--accent);animation:pulse 2s infinite;}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
  .balance-amount{color:var(--accent);font-weight:700;}
  .user-chip{background:var(--surface);border:1px solid var(--border);border-radius:100px;padding:6px 16px 6px 10px;display:flex;align-items:center;gap:10px;}
  .avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--accent3),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;color:white;font-family:'Space Mono',monospace;}
  .user-name{font-size:13px;font-weight:500;}
  .logout-btn{background:none;border:1px solid var(--border);border-radius:8px;color:var(--muted);padding:6px 12px;cursor:pointer;font-size:12px;font-family:'Space Mono',monospace;transition:all .2s;}
  .logout-btn:hover{border-color:var(--accent2);color:var(--accent2);}
  main{max-width:900px;margin:0 auto;padding:32px 24px;}
  .page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:32px;}
  .page-title{font-family:'Bebas Neue',cursive;font-size:36px;letter-spacing:2px;}
  .page-subtitle{font-size:13px;color:var(--muted);font-family:'Space Mono',monospace;margin-top:4px;}
  .btn-new{display:flex;align-items:center;gap:10px;background:linear-gradient(135deg,var(--accent),#00cc6a);color:#0a0a0f;border:none;border-radius:10px;padding:12px 22px;font-weight:700;font-size:13px;letter-spacing:1px;text-transform:uppercase;cursor:pointer;font-family:'Space Mono',monospace;transition:all .2s;}
  .btn-new:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,255,136,.3);}
  .btn-new-icon{width:22px;height:22px;background:rgba(0,0,0,.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;}
  .bets-list{display:flex;flex-direction:column;gap:12px;}
  .bet-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px 24px;cursor:pointer;transition:all .25s;position:relative;overflow:hidden;}
  .bet-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:linear-gradient(180deg,var(--accent),var(--accent3));border-radius:3px 0 0 3px;opacity:0;transition:opacity .25s;}
  .bet-card:hover{border-color:rgba(0,255,136,.3);transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,.3),var(--glow);}
  .bet-card:hover::before{opacity:1;}
  .bet-card.mine{border-color:rgba(123,97,255,.3);}
  .bet-card.mine::before{background:linear-gradient(180deg,var(--accent3),var(--accent2));}
  .bet-card.resolved-card{opacity:.75;}
  .bet-card-top{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;margin-bottom:14px;}
  .bet-question{font-size:15px;font-weight:500;line-height:1.5;flex:1;}
  .bet-badges{display:flex;flex-direction:column;align-items:flex-end;gap:6px;flex-shrink:0;}
  .badge{padding:4px 10px;border-radius:100px;font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;font-family:'Space Mono',monospace;}
  .badge-open{background:rgba(0,255,136,.12);color:var(--accent);border:1px solid rgba(0,255,136,.25);}
  .badge-closed{background:rgba(255,51,102,.12);color:var(--accent2);border:1px solid rgba(255,51,102,.25);}
  .badge-ended{background:rgba(107,107,138,.15);color:var(--muted);border:1px solid var(--border);}
  .badge-mine{background:rgba(123,97,255,.12);color:var(--accent3);border:1px solid rgba(123,97,255,.3);}
  .badge-resolved{background:rgba(0,255,136,.08);color:var(--accent);border:1px solid rgba(0,255,136,.2);}
  .bet-meta{display:flex;gap:20px;flex-wrap:wrap;}
  .meta-item{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);font-family:'Space Mono',monospace;}
  .meta-value{color:var(--text);font-weight:600;}
  .bet-bar-wrap{margin-top:14px;}
  .bet-bar{height:4px;background:var(--bg);border-radius:4px;overflow:hidden;display:flex;}
  .bet-bar-yes{height:100%;background:var(--yes);transition:width .6s cubic-bezier(.4,0,.2,1);}
  .bet-bar-no{height:100%;background:var(--no);transition:width .6s cubic-bezier(.4,0,.2,1);}
  .bet-bar-labels{display:flex;justify-content:space-between;margin-top:6px;font-size:11px;font-family:'Space Mono',monospace;}
  .yes-pct{color:var(--yes);font-weight:700;}
  .no-pct{color:var(--no);font-weight:700;}
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;display:flex;align-items:center;justify-content:center;padding:24px;opacity:0;pointer-events:none;transition:opacity .3s;backdrop-filter:blur(6px);}
  .modal-overlay.open{opacity:1;pointer-events:all;}
  .create-modal{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:40px;width:100%;max-width:560px;position:relative;transform:translateY(20px);transition:transform .3s;max-height:90vh;overflow-y:auto;}
  .modal-overlay.open .create-modal,.modal-overlay.open .detail-modal{transform:translateY(0);}
  .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px;}
  .modal-title{font-family:'Bebas Neue',cursive;font-size:28px;letter-spacing:2px;}
  .modal-close{width:36px;height:36px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;color:var(--muted);transition:all .2s;flex-shrink:0;}
  .modal-close:hover{border-color:var(--accent2);color:var(--accent2);}
  textarea.input-field{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px 16px;color:var(--text);font-size:14px;font-family:'Inter',sans-serif;resize:vertical;min-height:90px;outline:none;transition:border-color .2s;}
  textarea.input-field:focus{border-color:var(--accent);}
  input.input-field{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px 16px;color:var(--text);font-size:14px;font-family:'Inter',sans-serif;outline:none;transition:border-color .2s;color-scheme:dark;}
  input.input-field:focus{border-color:var(--accent);}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
  .form-note{font-size:11px;color:var(--muted);font-family:'Space Mono',monospace;margin-top:6px;}
  .modal-error{color:var(--accent2);font-size:12px;text-align:center;font-family:'Space Mono',monospace;min-height:18px;margin-top:8px;}
  .detail-modal{background:var(--surface);border:1px solid var(--border);border-radius:20px;width:100%;max-width:860px;max-height:90vh;overflow-y:auto;position:relative;transform:translateY(20px);transition:transform .3s;}
  .detail-header{padding:32px 32px 24px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between;gap:16px;}
  .detail-question{font-size:18px;font-weight:600;line-height:1.4;flex:1;}
  .detail-body{display:grid;grid-template-columns:1fr 320px;}
  .detail-charts{padding:24px 32px;border-right:1px solid var(--border);}
  .chart-section{margin-bottom:28px;}
  .chart-label{font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);font-family:'Space Mono',monospace;margin-bottom:12px;}
  .chart-wrap{height:140px;position:relative;}
  .detail-sidebar{padding:24px;}
  .sidebar-section{margin-bottom:24px;}
  .sidebar-label{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);font-family:'Space Mono',monospace;margin-bottom:8px;}
  .vote-selector{display:flex;gap:8px;margin-bottom:16px;}
  .vote-btn{flex:1;padding:12px;border-radius:10px;border:2px solid var(--border);background:transparent;font-family:'Space Mono',monospace;font-weight:700;font-size:14px;cursor:pointer;transition:all .2s;letter-spacing:1px;}
  .vote-btn.yes{color:var(--yes);}
  .vote-btn.yes.active,.vote-btn.yes:hover{border-color:var(--yes);background:rgba(0,255,136,.1);}
  .vote-btn.no{color:var(--no);}
  .vote-btn.no.active,.vote-btn.no:hover{border-color:var(--no);background:rgba(255,51,102,.1);}
  .amount-input-wrap{position:relative;margin-bottom:8px;}
  .amount-input-wrap input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px 40px 12px 16px;color:var(--text);font-size:14px;font-family:'Space Mono',monospace;outline:none;transition:border-color .2s;color-scheme:dark;}
  .amount-input-wrap input:focus{border-color:var(--accent);}
  .amount-currency{position:absolute;right:14px;top:50%;transform:translateY(-50%);font-size:12px;color:var(--muted);font-family:'Space Mono',monospace;}
  .payout-display{background:var(--bg);border:1px solid rgba(0,255,136,.2);border-radius:8px;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
  .payout-label{font-size:11px;color:var(--muted);font-family:'Space Mono',monospace;}
  .payout-value{font-family:'Space Mono',monospace;font-weight:700;color:var(--accent);font-size:16px;}
  .current-split{display:flex;justify-content:space-between;margin-bottom:6px;}
  .split-yes{font-family:'Space Mono',monospace;font-weight:700;color:var(--yes);font-size:13px;}
  .split-no{font-family:'Space Mono',monospace;font-weight:700;color:var(--no);font-size:13px;}
  .split-bar{height:6px;background:var(--bg);border-radius:6px;overflow:hidden;display:flex;margin-bottom:16px;}
  .split-bar-yes{height:100%;background:var(--yes);transition:width .5s;}
  .split-bar-no{height:100%;background:var(--no);transition:width .5s;}
  .btn-place{width:100%;padding:14px;background:linear-gradient(135deg,var(--accent),#00cc6a);color:#0a0a0f;font-weight:700;font-size:13px;letter-spacing:1px;text-transform:uppercase;border:none;border-radius:10px;cursor:pointer;font-family:'Space Mono',monospace;transition:all .2s;}
  .btn-place:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(0,255,136,.25);}
  .bet-info-rows{display:flex;flex-direction:column;gap:8px;margin-bottom:16px;}
  .info-row{display:flex;justify-content:space-between;font-size:12px;}
  .info-row .key{color:var(--muted);font-family:'Space Mono',monospace;}
  .info-row .val{color:var(--text);font-family:'Space Mono',monospace;font-weight:600;}
  .sidebar-msg{text-align:center;font-size:12px;color:var(--muted);font-family:'Space Mono',monospace;padding:16px;background:var(--bg);border-radius:8px;border:1px solid var(--border);line-height:1.6;}
  .resolve-section{margin-top:16px;padding-top:16px;border-top:1px solid var(--border);}
  .resolve-title{font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);font-family:'Space Mono',monospace;margin-bottom:10px;}
  .resolve-btns{display:flex;gap:8px;}
  .resolve-btn{flex:1;padding:10px;border-radius:8px;border:2px solid;background:transparent;font-family:'Space Mono',monospace;font-weight:700;font-size:12px;cursor:pointer;transition:all .2s;letter-spacing:1px;}
  .resolve-yes{color:var(--yes);border-color:var(--yes);}
  .resolve-yes:hover{background:rgba(0,255,136,.1);}
  .resolve-no{color:var(--no);border-color:var(--no);}
  .resolve-no:hover{background:rgba(255,51,102,.1);}
  .btn-delete{width:100%;padding:10px;background:transparent;border:1px solid rgba(255,51,102,.3);color:var(--accent2);border-radius:8px;cursor:pointer;font-family:'Space Mono',monospace;font-size:11px;letter-spacing:1px;text-transform:uppercase;transition:all .2s;margin-top:10px;}
  .btn-delete:hover{background:rgba(255,51,102,.1);border-color:var(--accent2);}
  .empty-state{text-align:center;padding:80px 24px;color:var(--muted);}
  .empty-icon{font-size:48px;margin-bottom:16px;}
  .empty-title{font-family:'Bebas Neue',cursive;font-size:28px;letter-spacing:2px;margin-bottom:8px;color:var(--text);}
  .empty-sub{font-size:14px;font-family:'Space Mono',monospace;}
  .toast{position:fixed;bottom:32px;right:32px;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px 20px;display:flex;align-items:center;gap:12px;font-size:13px;font-family:'Space Mono',monospace;z-index:500;transform:translateY(100px);opacity:0;transition:all .4s cubic-bezier(.4,0,.2,1);max-width:340px;box-shadow:0 8px 32px rgba(0,0,0,.4);}
  .toast.show{transform:translateY(0);opacity:1;}
  .toast.success{border-left:3px solid var(--accent);}
  .toast.error{border-left:3px solid var(--accent2);}
  .toast.info{border-left:3px solid var(--accent3);}
  ::-webkit-scrollbar{width:6px;}
  ::-webkit-scrollbar-track{background:transparent;}
  ::-webkit-scrollbar-thumb{background:var(--border);border-radius:6px;}
  @media(max-width:640px){
    .detail-body{grid-template-columns:1fr;}
    .detail-charts{border-right:none;border-bottom:1px solid var(--border);}
    .form-grid{grid-template-columns:1fr;}
    header{padding:0 16px;}
    main{padding:24px 16px;}
    .auth-box{padding:32px 24px;}
  }
</style>
</head>
<body>

<div id="loading-screen">
  <div class="loading-logo">JT</div>
  <div class="loading-bar-wrap"><div class="loading-bar"></div></div>
  <div class="loading-status" id="loading-status">Verbinde mit Firebase...</div>
</div>

<div id="auth-screen">
  <div class="auth-box">
    <div class="auth-logo">JT</div>
    <div class="auth-tagline">Social Prediction Market</div>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">Einloggen</button>
      <button class="auth-tab" onclick="switchAuthTab('register')">Registrieren</button>
    </div>
    <div id="login-form">
      <div class="input-group"><label>Benutzername</label><input type="text" id="login-user" placeholder="Dein Username" autocomplete="off"></div>
      <div class="input-group"><label>Passwort</label><input type="password" id="login-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"></div>
      <button class="btn-primary" onclick="login()">Einloggen</button>
    </div>
    <div id="register-form" style="display:none">
      <div class="input-group"><label>Benutzername</label><input type="text" id="reg-user" placeholder="WÃ¤hle einen Username" autocomplete="off"></div>
      <div class="input-group"><label>Passwort</label><input type="password" id="reg-pass" placeholder="Mindestens 4 Zeichen"></div>
      <button class="btn-primary" onclick="register()">Account erstellen â€” 100â‚¬ Startguthaben</button>
    </div>
    <div class="auth-error" id="auth-error"></div>
  </div>
</div>

<div id="app">
  <header>
    <div class="header-logo">JT</div>
    <div class="header-right">
      <div class="balance-chip">
        <div class="balance-dot"></div>
        <span>Guthaben:</span>
        <span class="balance-amount" id="header-balance">100.00â‚¬</span>
      </div>
      <div class="user-chip">
        <div class="avatar" id="header-avatar">?</div>
        <span class="user-name" id="header-username">User</span>
      </div>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </header>
  <main>
    <div class="page-header">
      <div>
        <div class="page-title">Aktuelle Wetten</div>
        <div class="page-subtitle" id="bets-count">0 aktive Wetten</div>
      </div>
      <button class="btn-new" onclick="openCreateModal()">
        <span class="btn-new-icon">+</span>Neue Wette
      </button>
    </div>
    <div class="bets-list" id="bets-list">
      <div class="empty-state"><div class="empty-icon">ğŸ¯</div><div class="empty-title">Laden...</div></div>
    </div>
  </main>
</div>

<div class="modal-overlay" id="create-overlay" onclick="closeOnOverlay(event,'create-overlay')">
  <div class="create-modal">
    <div class="modal-header">
      <div class="modal-title">Neue Wette</div>
      <div class="modal-close" onclick="closeCreateModal()">âœ•</div>
    </div>
    <div class="input-group">
      <label>Frage / Wette</label>
      <textarea class="input-field" id="new-question" placeholder="z.B. Trump sagt nÃ¤chste Woche mindestens 15x Russia..."></textarea>
    </div>
    <div class="form-grid">
      <div class="input-group">
        <label>Wettenannahme bis</label>
        <input type="datetime-local" class="input-field" id="new-bet-close">
        <div class="form-note">Mindestens 1 Tag ab jetzt</div>
      </div>
      <div class="input-group">
        <label>Wette endet am</label>
        <input type="datetime-local" class="input-field" id="new-bet-end">
        <div class="form-note">Muss nach Annahmeschluss sein</div>
      </div>
    </div>
    <div class="input-group">
      <label>Wettquote (optional)</label>
      <input type="number" class="input-field" id="new-bet-odds" placeholder="z.B. 1.75 â€” leer lassen fÃ¼r dynamische Quote" min="1.01" step="0.01">
      <div class="form-note">Feste Quote wie bei Sportwetten (z.B. 2.00 = doppelter Einsatz zurÃ¼ck). Leer lassen fÃ¼r normalen Modus.</div>
    </div>
    <button class="btn-primary" onclick="createBet()" style="margin-top:8px">Wette erÃ¶ffnen</button>
    <div class="modal-error" id="create-error"></div>
  </div>
</div>

<div class="modal-overlay" id="detail-overlay" onclick="closeOnOverlay(event,'detail-overlay')">
  <div class="detail-modal">
    <div class="detail-header">
      <div>
        <div class="detail-question" id="det-question">â€”</div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap" id="det-badges"></div>
      </div>
      <div class="modal-close" onclick="closeDetailModal()">âœ•</div>
    </div>
    <div class="detail-body">
      <div class="detail-charts">
        <div class="chart-section">
          <div class="chart-label">ğŸ“ˆ Gesamteinsatz Ã¼ber Zeit</div>
          <div class="chart-wrap"><canvas id="chart-volume"></canvas></div>
        </div>
        <div class="chart-section">
          <div class="chart-label">âš–ï¸ Ja / Nein VerhÃ¤ltnis Ã¼ber Zeit</div>
          <div class="chart-wrap"><canvas id="chart-split"></canvas></div>
        </div>
      </div>
      <div class="detail-sidebar">
        <div class="sidebar-section">
          <div class="sidebar-label">Info</div>
          <div class="bet-info-rows" id="det-info"></div>
        </div>
        <div class="sidebar-section" id="det-vote-section">
          <div class="sidebar-label">Deine Stimme</div>
          <div class="vote-selector">
            <button class="vote-btn yes" onclick="selectVote('yes')">JA</button>
            <button class="vote-btn no" onclick="selectVote('no')">NEIN</button>
          </div>
          <div class="amount-input-wrap">
            <input type="number" id="bet-amount" placeholder="Einsatz..." min="1" oninput="updatePayout()">
            <span class="amount-currency">â‚¬</span>
          </div>
          <div class="payout-display">
            <span class="payout-label">MÃ¶glicher Gewinn</span>
            <span class="payout-value" id="payout-val">â€” â‚¬</span>
          </div>
          <div id="det-odds-hint" style="display:none;font-size:11px;color:var(--accent3);font-family:'Space Mono',monospace;text-align:center;margin-bottom:10px;"></div>
          <div class="sidebar-label">Aktuell</div>
          <div class="current-split">
            <span class="split-yes" id="det-yes-pct">JA 50%</span>
            <span class="split-no" id="det-no-pct">NEIN 50%</span>
          </div>
          <div class="split-bar">
            <div class="split-bar-yes" id="det-split-yes" style="width:50%"></div>
            <div class="split-bar-no" id="det-split-no" style="width:50%"></div>
          </div>
          <button class="btn-place" onclick="placeBet()">Wette platzieren</button>
          <div class="modal-error" id="bet-error"></div>
        </div>
        <div class="sidebar-section" id="det-resolve-section" style="display:none">
          <div class="resolve-section">
            <div class="resolve-title">Ergebnis festlegen</div>
            <div class="resolve-btns">
              <button class="resolve-btn resolve-yes" onclick="resolveBet('yes')">âœ“ JA</button>
              <button class="resolve-btn resolve-no" onclick="resolveBet('no')">âœ— NEIN</button>
            </div>
          </div>
        </div>
        <div class="sidebar-section" id="det-msg-section" style="display:none">
          <div class="sidebar-msg" id="det-msg-text"></div>
        </div>
        <div class="sidebar-section" id="det-delete-section" style="display:none">
          <button class="btn-delete" onclick="deleteBet()">ğŸ—‘ Wette lÃ¶schen</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  EINZIGER script type="module" â€” kein Race Condition
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script type="module">

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¼â–¼â–¼  FIREBASE-KONFIGURATION EINTRAGEN  â–¼â–¼â–¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
import { initializeApp }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, doc, getDoc,
  setDoc, addDoc, updateDoc, deleteDoc,
  onSnapshot, query, orderBy
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBbtNRoUiuuKrJBO9ulPNVNCo_h1woEF_A",
  authDomain: "jt-betting.firebaseapp.com",
  projectId: "jt-betting",
  storageBucket: "jt-betting.firebasestorage.app",
  messagingSenderId: "175871107945",
  appId: "1:175871107945:web:d8a2cc669da103d6d093f8"
};
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–²â–²â–²  ENDE KONFIGURATION               â–²â–²â–²
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

let currentUser        = null;
let currentDetailBetId = null;
let selectedVote       = null;
let volumeChart        = null;
let splitChart         = null;
let betsUnsub          = null;
let allBets            = [];

// â”€â”€ Boot (top-level await in module) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setStatus('Firebase verbunden âœ“');
try {
  const saved = sessionStorage.getItem('jt_user');
  if (saved) {
    const snap = await getDoc(doc(db, 'users', saved));
    if (snap.exists()) {
      currentUser = saved;
      hideLoading();
      enterApp();
    } else {
      sessionStorage.removeItem('jt_user');
      showAuth();
    }
  } else {
    showAuth();
  }
} catch(e) {
  setStatus('Verbindungsfehler: ' + e.message);
}

// â”€â”€ Hilfsfunktionen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(m){ document.getElementById('loading-status').textContent = m; }
function hideLoading(){ document.getElementById('loading-screen').style.display = 'none'; }
function showAuth(){ hideLoading(); document.getElementById('auth-screen').style.display = 'flex'; }
function showEl(id){ document.getElementById(id).style.display = 'block'; }
function hideEl(id){ document.getElementById(id).style.display = 'none'; }
function setTxt(id,t){ document.getElementById(id).textContent = t; }

function fmtMoney(n){ return (Math.round(n*100)/100).toFixed(2)+'â‚¬'; }
function todayStr(){ return new Date().toISOString().slice(0,10); }
function fmtDate(ms){ return new Date(ms).toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}); }
function fmtShort(ms){ const d=new Date(ms); return `${d.getDate()}.${d.getMonth()+1} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function toInput(d){ const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`; }

let _toastTimer=null;
function toast(msg,type='info'){
  const t=document.getElementById('toast');
  t.className=`toast ${type}`; t.innerHTML=`<span>${msg}</span>`;
  clearTimeout(_toastTimer); void t.offsetWidth; t.classList.add('show');
  _toastTimer=setTimeout(()=>t.classList.remove('show'),3500);
}

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.switchAuthTab = function(tab){
  document.querySelectorAll('.auth-tab').forEach((t,i)=>t.classList.toggle('active',(i===0&&tab==='login')||(i===1&&tab==='register')));
  document.getElementById('login-form').style.display    = tab==='login'   ?'':'none';
  document.getElementById('register-form').style.display = tab==='register'?'':'none';
  document.getElementById('auth-error').textContent='';
};

window.register = async function(){
  const u=document.getElementById('reg-user').value.trim();
  const p=document.getElementById('reg-pass').value;
  const err=document.getElementById('auth-error');
  if(!u||u.length<2)             {err.textContent='Benutzername zu kurz';return;}
  if(!p||p.length<4)             {err.textContent='Passwort zu kurz (min. 4 Zeichen)';return;}
  if(!/^[a-zA-Z0-9_-]+$/.test(u)){err.textContent='Nur Buchstaben, Zahlen, _ und - erlaubt';return;}
  try{
    if((await getDoc(doc(db,'users',u))).exists()){err.textContent='Benutzername bereits vergeben';return;}
    await setDoc(doc(db,'users',u),{password:p,balance:100,betsMadeToday:0,lastBetDate:''});
    err.style.color='var(--accent)'; err.textContent='Account erstellt! Jetzt einloggen.';
    setTimeout(()=>{err.textContent='';err.style.color='';switchAuthTab('login');},1500);
  }catch(e){err.textContent='Fehler: '+e.message;}
};

window.login = async function(){
  const u=document.getElementById('login-user').value.trim();
  const p=document.getElementById('login-pass').value;
  const err=document.getElementById('auth-error');
  if(!u||!p){err.textContent='Bitte alle Felder ausfÃ¼llen';return;}
  try{
    const snap=await getDoc(doc(db,'users',u));
    if(!snap.exists()||snap.data().password!==p){err.textContent='Falscher Benutzername oder Passwort';return;}
    currentUser=u; sessionStorage.setItem('jt_user',u);
    hideEl('auth-screen'); enterApp();
  }catch(e){err.textContent='Fehler: '+e.message;}
};

window.logout = function(){
  currentUser=null; sessionStorage.removeItem('jt_user');
  if(betsUnsub){betsUnsub();betsUnsub=null;}
  hideEl('app'); document.getElementById('auth-screen').style.display='flex';
};

// â”€â”€ App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function enterApp(){
  document.getElementById('app').style.display='block';
  updateHeader(); subscribeToData();
  setInterval(autoDeleteExpired,5*60*1000);
}

async function updateHeader(){
  try{
    const snap=await getDoc(doc(db,'users',currentUser));
    if(!snap.exists())return;
    const u=snap.data();
    setTxt('header-username',currentUser);
    setTxt('header-avatar',currentUser.charAt(0).toUpperCase());
    setTxt('header-balance',fmtMoney(u.balance));
  }catch(e){console.warn(e);}
}

function subscribeToData(){
  const q=query(collection(db,'bets'),orderBy('createdAt','desc'));
  betsUnsub=onSnapshot(q,snap=>{
    allBets=snap.docs.map(d=>({...d.data(),id:d.id}));
    allBets.sort((a,b)=>{
      const o={open:0,closed:1,ended:2,resolved:3};
      const sa=status(a),sb=status(b);
      return o[sa]!==o[sb]?o[sa]-o[sb]:b.createdAt-a.createdAt;
    });
    renderBets(); updateHeader(); autoDeleteExpired();
  },e=>console.error('Snapshot:',e));
}

async function autoDeleteExpired(){
  const now=Date.now();
  for(const bet of allBets){
    if(bet.resolved&&bet.resolvedAt&&(now-bet.resolvedAt)>86400000){
      try{await deleteDoc(doc(db,'bets',bet.id));}catch(e){}
    }
  }
}

function status(bet){
  const now=Date.now();
  if(bet.resolved)return 'resolved';
  if(now>bet.endDate)return 'ended';
  if(now>bet.closeDate)return 'closed';
  return 'open';
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBets(){
  const list=document.getElementById('bets-list');
  if(!allBets.length){
    list.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ¯</div><div class="empty-title">Noch keine Wetten</div><div class="empty-sub">Erstelle die erste Wette!</div></div>';
    setTxt('bets-count','0 aktive Wetten'); return;
  }
  const active=allBets.filter(b=>status(b)==='open').length;
  setTxt('bets-count',`${active} offen Â· ${allBets.length} gesamt`);
  list.innerHTML=allBets.map(bet=>{
    const st=status(bet),total=(bet.stakeYes||0)+(bet.stakeNo||0);
    const yp=total>0?Math.round((bet.stakeYes||0)/total*100):50,np=100-yp;
    const isMine=bet.creator===currentUser;
    const parts=bet.participants?Object.values(bet.participants):[];
    const didBet=parts.some(p=>p.user===currentUser);
    const sb={open:'<span class="badge badge-open">ğŸŸ¢ Offen</span>',closed:'<span class="badge badge-closed">ğŸ”´ Annahme zu</span>',ended:'<span class="badge badge-ended">â± Beendet</span>',resolved:`<span class="badge badge-resolved">âœ“ ${bet.winner==='yes'?'JA gewann':'NEIN gewann'}</span>`}[st];
    let dn='';
    if(st==='resolved'&&bet.resolvedAt){const h=Math.ceil((bet.resolvedAt+86400000-Date.now())/3600000);if(h>0)dn=`<div class="meta-item"><span class="meta-icon">ğŸ—‘</span><span>Wird in ~${h}h entfernt</span></div>`;}
    return `<div class="bet-card ${isMine?'mine':''} ${st==='resolved'?'resolved-card':''}" onclick="openDetailModal('${bet.id}')">
      <div class="bet-card-top"><div class="bet-question">${esc(bet.question)}</div>
        <div class="bet-badges">${sb}${isMine?'<span class="badge badge-mine">âš™ Meine</span>':''}${didBet&&!isMine?'<span class="badge badge-mine" style="background:rgba(0,255,136,.08);color:var(--accent);border-color:rgba(0,255,136,.2)">âœ“ Gewettet</span>':''}</div>
      </div>
      <div class="bet-meta">
        <div class="meta-item"><span class="meta-icon">ğŸ‘¤</span><span>${esc(bet.creator)}</span></div>
        <div class="meta-item"><span class="meta-icon">ğŸ’°</span><span class="meta-value">${fmtMoney(total)}</span> Gesamt</div>
        <div class="meta-item"><span class="meta-icon">ğŸ“…</span><span>Annahme: <span class="meta-value">${fmtDate(bet.closeDate)}</span></span></div>
        <div class="meta-item"><span class="meta-icon">ğŸ</span><span>Ende: <span class="meta-value">${fmtDate(bet.endDate)}</span></span></div>
        ${bet.fixedOdds?`<div class="meta-item"><span class="meta-icon">ğŸ“Š</span><span>Quote: <span class="meta-value" style="color:var(--accent3)">${bet.fixedOdds.toFixed(2)}x</span></span></div>`:''}
        ${dn}
      </div>
      <div class="bet-bar-wrap">
        <div class="bet-bar"><div class="bet-bar-yes" style="width:${yp}%"></div><div class="bet-bar-no" style="width:${np}%"></div></div>
        <div class="bet-bar-labels"><span class="yes-pct">JA ${yp}%</span><span class="no-pct">NEIN ${np}%</span></div>
      </div></div>`;
  }).join('');
}

// â”€â”€ Create Bet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openCreateModal = async function(){
  try{
    const snap=await getDoc(doc(db,'users',currentUser));
    const u=snap.data(),today=todayStr();
    if(u.lastBetDate!==today){await updateDoc(doc(db,'users',currentUser),{betsMadeToday:0,lastBetDate:today});u.betsMadeToday=0;}
    if(u.betsMadeToday>=2){toast('Du hast heute bereits 2 Wetten erÃ¶ffnet!','error');return;}
  }catch(e){toast('Fehler: '+e.message,'error');return;}
  const now=new Date(),mc=new Date(now.getTime()+86400000),me=new Date(mc.getTime()+3600000);
  document.getElementById('new-bet-close').value=toInput(mc);
  document.getElementById('new-bet-end').value=toInput(me);
  document.getElementById('new-question').value='';
  document.getElementById('new-bet-odds').value='';
  document.getElementById('create-error').textContent='';
  document.getElementById('create-overlay').classList.add('open');
};

window.closeCreateModal = function(){ document.getElementById('create-overlay').classList.remove('open'); };

window.createBet = async function(){
  const q=document.getElementById('new-question').value.trim();
  const cs=document.getElementById('new-bet-close').value;
  const es=document.getElementById('new-bet-end').value;
  const oddsRaw=document.getElementById('new-bet-odds').value.trim();
  const err=document.getElementById('create-error');
  if(!q){err.textContent='Bitte eine Frage eingeben';return;}
  if(!cs||!es){err.textContent='Bitte alle Daten ausfÃ¼llen';return;}
  const now=Date.now(),cd=new Date(cs).getTime(),ed=new Date(es).getTime();
  if(cd<now+82800000){err.textContent='Annahmeschluss muss mindestens 1 Tag in der Zukunft liegen';return;}
  if(ed<=cd){err.textContent='Enddatum muss nach dem Annahmeschluss liegen';return;}
  let fixedOdds=null;
  if(oddsRaw!==''){
    fixedOdds=parseFloat(oddsRaw);
    if(isNaN(fixedOdds)||fixedOdds<1.01){err.textContent='Wettquote muss mindestens 1.01 sein';return;}
    fixedOdds=Math.round(fixedOdds*100)/100;
  }
  try{
    const snap=await getDoc(doc(db,'users',currentUser));
    const u=snap.data(),today=todayStr();
    const made=u.lastBetDate===today?u.betsMadeToday:0;
    if(made>=2){err.textContent='Tageslimit (2 Wetten) erreicht';return;}
    await addDoc(collection(db,'bets'),{
      question:q,creator:currentUser,createdAt:now,
      closeDate:cd,endDate:ed,resolved:false,winner:null,
      stakeYes:0,stakeNo:0,participants:{},
      history:{[String(now)]:{yesTotal:0,noTotal:0}},
      ...(fixedOdds!==null?{fixedOdds}:{})
    });
    await updateDoc(doc(db,'users',currentUser),{betsMadeToday:made+1,lastBetDate:today});
    closeCreateModal(); toast('Wette erÃ¶ffnet! ğŸ¯','success');
  }catch(e){err.textContent='Fehler: '+e.message;}
};

// â”€â”€ Detail Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openDetailModal = function(id){
  currentDetailBetId=id; selectedVote=null;
  const bet=allBets.find(b=>b.id===id);
  if(!bet)return;
  const st=status(bet),total=(bet.stakeYes||0)+(bet.stakeNo||0);
  const yp=total>0?Math.round((bet.stakeYes||0)/total*100):50,np=100-yp;
  const isMine=bet.creator===currentUser;
  const parts=bet.participants?Object.values(bet.participants):[];
  const didBet=parts.some(p=>p.user===currentUser);
  const myBet=parts.find(p=>p.user===currentUser);

  setTxt('det-question',bet.question);
  const be=document.getElementById('det-badges'); be.innerHTML='';
  const sb=document.createElement('span');
  sb.className=`badge badge-${st==='resolved'?'resolved':st}`;
  sb.textContent={open:'ğŸŸ¢ Offen',closed:'ğŸ”´ Annahme geschlossen',ended:'â± Beendet',resolved:`âœ“ ${bet.winner==='yes'?'JA gewonnen':'NEIN gewonnen'}`}[st];
  be.appendChild(sb);
  if(isMine){const m=document.createElement('span');m.className='badge badge-mine';m.textContent='âš™ Meine Wette';be.appendChild(m);}

  document.getElementById('det-info').innerHTML=`
    <div class="info-row"><span class="key">Ersteller</span><span class="val">${esc(bet.creator)}</span></div>
    <div class="info-row"><span class="key">Annahme bis</span><span class="val">${fmtDate(bet.closeDate)}</span></div>
    <div class="info-row"><span class="key">Endet am</span><span class="val">${fmtDate(bet.endDate)}</span></div>
    ${bet.fixedOdds?`<div class="info-row"><span class="key">Wettquote</span><span class="val" style="color:var(--accent3)">${bet.fixedOdds.toFixed(2)}x</span></div>`:''}
    <div class="info-row"><span class="key">Gesamteinsatz</span><span class="val">${fmtMoney(total)}</span></div>
    <div class="info-row"><span class="key">Teilnehmer</span><span class="val">${parts.length}</span></div>
    ${bet.resolved?`<div class="info-row"><span class="key">Ergebnis</span><span class="val" style="color:${bet.winner==='yes'?'var(--yes)':'var(--no)'}">
    ${bet.winner==='yes'?'âœ“ JA':'âœ— NEIN'}</span></div>`:''}`;

  setTxt('det-yes-pct',`JA ${yp}%`); setTxt('det-no-pct',`NEIN ${np}%`);
  document.getElementById('det-split-yes').style.width=yp+'%';
  document.getElementById('det-split-no').style.width=np+'%';
  document.querySelectorAll('.vote-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('bet-amount').value='';
  setTxt('payout-val','â€” â‚¬'); setTxt('bet-error','');
  document.getElementById('det-msg-text').style.color='';
  const oddsHint=document.getElementById('det-odds-hint');
  if(bet.fixedOdds){oddsHint.textContent=`ğŸ“Š Feste Quote: ${bet.fixedOdds.toFixed(2)}x â€” Gewinn = Einsatz Ã— ${bet.fixedOdds.toFixed(2)}`;oddsHint.style.display='block';}
  else{oddsHint.style.display='none';}
  ['det-vote-section','det-resolve-section','det-msg-section','det-delete-section'].forEach(hideEl);

  if(st==='open'){
    if(isMine){showEl('det-msg-section');setTxt('det-msg-text','Du kannst nicht auf deine eigene Wette wetten.');showEl('det-delete-section');}
    else if(didBet){showEl('det-msg-section');setTxt('det-msg-text',`Du hast bereits ${fmtMoney(myBet.amount)} auf "${myBet.side==='yes'?'JA':'NEIN'}" gesetzt.`);}
    else showEl('det-vote-section');
  } else if(st==='ended'&&isMine&&!bet.resolved){
    showEl('det-resolve-section');showEl('det-msg-section');setTxt('det-msg-text','Die Wette ist beendet. Lege das Ergebnis fest!');
  } else if(st==='closed'){
    showEl('det-msg-section');setTxt('det-msg-text','Annahmeschluss vorbei. Keine neuen EinsÃ¤tze mÃ¶glich.');
    if(isMine)showEl('det-delete-section');
  } else if(st==='ended'&&!isMine){
    showEl('det-msg-section');setTxt('det-msg-text','Warte auf Entscheidung des Erstellers...');
  } else if(st==='resolved'){
    showEl('det-msg-section');
    if(myBet){const won=myBet.side===bet.winner;setTxt('det-msg-text',won?'ğŸ‰ Du hast gewonnen!':'Du hast leider verloren.');document.getElementById('det-msg-text').style.color=won?'var(--yes)':'var(--no)';}
    else setTxt('det-msg-text','Wette aufgelÃ¶st.');
  }
  buildCharts(bet);
  document.getElementById('detail-overlay').classList.add('open');
};

window.closeDetailModal = function(){
  document.getElementById('detail-overlay').classList.remove('open');
  if(volumeChart){volumeChart.destroy();volumeChart=null;}
  if(splitChart){splitChart.destroy();splitChart=null;}
};

// â”€â”€ Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildCharts(bet){
  if(volumeChart){volumeChart.destroy();volumeChart=null;}
  if(splitChart){splitChart.destroy();splitChart=null;}
  const hist=bet.history?Object.entries(bet.history).sort((a,b)=>Number(a[0])-Number(b[0])):[[String(bet.createdAt),{yesTotal:0,noTotal:0}]];
  const labels=hist.map(([t])=>fmtShort(Number(t)));
  const vols=hist.map(([,h])=>(h.yesTotal||0)+(h.noTotal||0));
  const yps=hist.map(([,h])=>{const t=(h.yesTotal||0)+(h.noTotal||0);return t>0?Math.round((h.yesTotal||0)/t*100):50;});
  const nps=yps.map(p=>100-p);
  const base={responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:'#12121a',borderColor:'#2a2a3d',borderWidth:1,titleColor:'#e8e8f0',bodyColor:'#6b6b8a'}},scales:{x:{grid:{color:'rgba(255,255,255,.04)'},ticks:{color:'#6b6b8a',font:{family:'Space Mono',size:9},maxTicksLimit:6}},y:{grid:{color:'rgba(255,255,255,.04)'},ticks:{color:'#6b6b8a',font:{family:'Space Mono',size:9}}}}};
  volumeChart=new Chart(document.getElementById('chart-volume').getContext('2d'),{type:'line',data:{labels,datasets:[{label:'â‚¬',data:vols,borderColor:'#7b61ff',backgroundColor:'rgba(123,97,255,.1)',borderWidth:2,fill:true,tension:.4,pointRadius:3,pointBackgroundColor:'#7b61ff'}]},options:{...base}});
  splitChart=new Chart(document.getElementById('chart-split').getContext('2d'),{type:'line',data:{labels,datasets:[{label:'JA %',data:yps,borderColor:'#00ff88',backgroundColor:'rgba(0,255,136,.08)',borderWidth:2,fill:true,tension:.4,pointRadius:3,pointBackgroundColor:'#00ff88'},{label:'NEIN %',data:nps,borderColor:'#ff3366',backgroundColor:'rgba(255,51,102,.08)',borderWidth:2,fill:true,tension:.4,pointRadius:3,pointBackgroundColor:'#ff3366'}]},options:{...base,plugins:{...base.plugins,legend:{display:true,labels:{color:'#6b6b8a',font:{family:'Space Mono',size:10}}}},scales:{...base.scales,y:{...base.scales.y,min:0,max:100}}}});
}

// â”€â”€ Bet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.selectVote = function(side){
  selectedVote=side;
  document.querySelectorAll('.vote-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector(`.vote-btn.${side}`).classList.add('active');
  updatePayout();
};

window.updatePayout = function(){
  if(!currentDetailBetId||!selectedVote){setTxt('payout-val','â€” â‚¬');return;}
  const amt=parseFloat(document.getElementById('bet-amount').value)||0;
  if(amt<=0){setTxt('payout-val','â€” â‚¬');return;}
  const bet=allBets.find(b=>b.id===currentDetailBetId);
  if(bet.fixedOdds){
    setTxt('payout-val',fmtMoney(Math.round(bet.fixedOdds*amt*100)/100));
  }else{
    const yT=(bet.stakeYes||0)+(selectedVote==='yes'?amt:0);
    const nT=(bet.stakeNo||0)+(selectedVote==='no'?amt:0);
    const tot=yT+nT,st=selectedVote==='yes'?yT:nT;
    setTxt('payout-val',fmtMoney(st>0?(tot/st)*amt:amt));
  }
};

window.placeBet = async function(){
  const err=document.getElementById('bet-error');
  if(!selectedVote){err.textContent='Bitte JA oder NEIN wÃ¤hlen';return;}
  const amt=parseFloat(document.getElementById('bet-amount').value);
  if(!amt||amt<1){err.textContent='Mindestens 1â‚¬ Einsatz';return;}
  try{
    const bet=allBets.find(b=>b.id===currentDetailBetId);
    const snap=await getDoc(doc(db,'users',currentUser));
    const u=snap.data();
    if(amt>u.balance){err.textContent='Nicht genug Guthaben';return;}
    const nb=Math.round((u.balance-amt)*100)/100;
    const sf=selectedVote==='yes'?'stakeYes':'stakeNo';
    const ns=Math.round(((bet[sf]||0)+amt)*100)/100;
    const now=Date.now();
    await updateDoc(doc(db,'users',currentUser),{balance:nb});
    await updateDoc(doc(db,'bets',bet.id),{
      [sf]:ns,
      [`participants.${currentUser}`]:{user:currentUser,side:selectedVote,amount:amt,time:now},
      [`history.${now}`]:{yesTotal:selectedVote==='yes'?ns:(bet.stakeYes||0),noTotal:selectedVote==='no'?ns:(bet.stakeNo||0)}
    });
    closeDetailModal(); toast(`${fmtMoney(amt)} auf "${selectedVote==='yes'?'JA':'NEIN'}" gesetzt! ğŸ¯`,'success');
  }catch(e){err.textContent='Fehler: '+e.message;}
};

// â”€â”€ Resolve â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.resolveBet = async function(winner){
  const bet=allBets.find(b=>b.id===currentDetailBetId);
  if(!bet||bet.resolved)return;
  try{
    const sw=winner==='yes'?(bet.stakeYes||0):(bet.stakeNo||0);
    const tot=(bet.stakeYes||0)+(bet.stakeNo||0);
    const parts=bet.participants?Object.values(bet.participants):[];
    const winners=parts.filter(p=>p.side===winner);
    await updateDoc(doc(db,'bets',bet.id),{resolved:true,winner,resolvedAt:Date.now()});
    if(winners.length===0){
      for(const p of parts){const s=await getDoc(doc(db,'users',p.user));if(s.exists())await updateDoc(doc(db,'users',p.user),{balance:Math.round((s.data().balance+p.amount)*100)/100});}
      toast('Keine Gewinner â€” EinsÃ¤tze zurÃ¼ckerstattet.','info');
    }else{
      for(const p of winners){
        let po;
        if(bet.fixedOdds){po=Math.round(bet.fixedOdds*p.amount*100)/100;}
        else{po=sw>0?(tot/sw)*p.amount:p.amount;}
        const s=await getDoc(doc(db,'users',p.user));
        if(s.exists())await updateDoc(doc(db,'users',p.user),{balance:Math.round((s.data().balance+po)*100)/100});
      }
      toast(`Wette aufgelÃ¶st! ${winner==='yes'?'JA':'NEIN'} gewinnt! ğŸ‰`,'success');
    }
    closeDetailModal();
  }catch(e){toast('Fehler: '+e.message,'error');}
};

// â”€â”€ Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.deleteBet = async function(){
  const bet=allBets.find(b=>b.id===currentDetailBetId);
  if(!bet||bet.creator!==currentUser)return;
  if(!confirm('Wette wirklich lÃ¶schen? Alle EinsÃ¤tze werden zurÃ¼ckerstattet.'))return;
  try{
    const parts=bet.participants?Object.values(bet.participants):[];
    for(const p of parts){const s=await getDoc(doc(db,'users',p.user));if(s.exists())await updateDoc(doc(db,'users',p.user),{balance:Math.round((s.data().balance+p.amount)*100)/100});}
    await deleteDoc(doc(db,'bets',bet.id));
    closeDetailModal(); toast('Wette gelÃ¶scht. EinsÃ¤tze zurÃ¼ckerstattet.','info');
  }catch(e){toast('Fehler: '+e.message,'error');}
};

// â”€â”€ Misc â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.closeOnOverlay = function(e,id){
  if(e.target.id===id){if(id==='create-overlay')closeCreateModal();else closeDetailModal();}
};
document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeCreateModal();closeDetailModal();}});

</script>
</body>
</html>
